<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ranniå®å®èµ·åºŠå•¦</title>

  <style>
    :root{
      --bgA:#0b0620;
      --bgB:#1a0f3a;
      --bgC:#7c3aed;
      --bgD:#d8b4fe;
      --bgE:#f5e9ff;

      --ink:#1b1530;
      --muted:#6b5a95;
      --card: rgba(255,255,255,.86);
      --border: rgba(255,255,255,.22);
      --shadow: 0 18px 44px rgba(20, 8, 60, .22);
      --r:20px;

      --accent:#a78bfa;
      --accent2:#fb7185;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC","Microsoft Yahei", Arial;
      color:var(--ink);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background:
        radial-gradient(980px 560px at 12% 10%, var(--bgE), transparent 62%),
        radial-gradient(980px 560px at 92% 18%, var(--bgD), transparent 62%),
        radial-gradient(900px 520px at 55% 96%, rgba(124,58,237,.42), transparent 62%),
        radial-gradient(700px 420px at 50% 40%, rgba(251,113,133,.16), transparent 60%),
        linear-gradient(180deg, var(--bgA), var(--bgB));
    }

    .wrap{width:min(1040px, 100%)}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:12px; flex-wrap:wrap;
    }
    .pill{
      padding:8px 12px;
      border:1px solid rgba(255,255,255,.26);
      background: rgba(255,255,255,.78);
      border-radius:999px;
      font-size:13px;
      color:var(--muted);
      box-shadow: 0 10px 26px rgba(20,8,60,.16);
      user-select:none;
      backdrop-filter: blur(8px);
    }

    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.24);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .main{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
      padding:14px;
    }
    @media (max-width: 980px){ .main{grid-template-columns:1fr} }

    /* å·¦ä¾§è´´çº¸ */
    .sticker{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.22);
      background:
        radial-gradient(240px 240px at 28% 20%, rgba(255,255,255,.95), rgba(245,233,255,.92));
      box-shadow: 0 18px 42px rgba(20,8,60,.18);
      position:relative;
      overflow:hidden;
    }
    .st-bubble{
      position:absolute; top:14px; left:14px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.24);
      border-radius:16px;
      padding:10px 12px;
      font-weight:900;
      box-shadow: 0 12px 26px rgba(20,8,60,.14);
      white-space:pre-line;
      max-width:84%;
      z-index:3;
    }
    .chars{
      position:absolute; inset:0;
      display:flex;
      align-items:flex-end;
      justify-content:space-around;
      padding:64px 16px 16px;
      gap:12px;
      z-index:1;
    }
    .c{
      width:48%;
      height:78%;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.24);
      background: rgba(255,255,255,.82);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .stImg{
      width:100%;
      height:100%;
      object-fit:contain;
      transform: scale(1.16);
      transform-origin:center bottom;
      pointer-events:none;
      display:block;
    }
    .tag{
      position:absolute; bottom:10px; left:50%;
      transform:translateX(-50%);
      font-size:12px; color:var(--muted);
      background: rgba(255,255,255,.88);
      border:1px solid rgba(255,255,255,.24);
      border-radius:999px; padding:6px 10px;
      z-index:4;
    }
    .imgfail::before{
      content:"è´´çº¸æ²¡åŠ è½½åˆ°ï¼šç¡®è®¤ hachi.webp / usagi.webp åœ¨ä»“åº“æ ¹ç›®å½•ï¼ˆå¤§å°å†™ä¸€è‡´ï¼‰";
      position:absolute;
      inset:auto 10px 44px 10px;
      text-align:center;
      font-size:12px;
      color: rgba(27,21,48,.60);
      background: rgba(255,255,255,.60);
      border:1px dashed rgba(255,255,255,.35);
      border-radius:12px;
      padding:10px;
    }

    .shake{animation: shake .28s ease-in-out 1}
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      50%{transform:translateX(6px)}
      75%{transform:translateX(-4px)}
      100%{transform:translateX(0)}
    }

    /* å³ä¾§ */
    .panel{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.24);
      background: rgba(255,255,255,.72);
      padding:14px;
      min-height:420px;
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .title{margin:0 0 6px; font-size:22px; font-weight:950; letter-spacing:.2px;}
    .sub{margin:0 0 14px; color:var(--muted); line-height:1.6; font-size:14px;}

    .dialog{
      border:1px solid rgba(255,255,255,.26);
      background: rgba(255,255,255,.92);
      border-radius:16px;
      padding:12px 12px;
      line-height:1.7;
      box-shadow: 0 10px 24px rgba(20,8,60,.14);
      white-space:pre-line;
    }
    .options{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}

    button{
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.86);
      border-radius:14px;
      padding:12px 14px;
      font-size:14px;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(20,8,60,.14);
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
      color: var(--ink);
      backdrop-filter: blur(8px);
    }
    button:hover{box-shadow:0 14px 34px rgba(20,8,60,.22); filter: brightness(1.02);}
    button:active{transform:translateY(1px) scale(.99)}
    .primary{
      border-color: rgba(124,58,237,.34);
      background: linear-gradient(180deg, rgba(167,139,250,.26), rgba(255,255,255,.92));
    }
    .danger{
      border-color: rgba(251,113,133,.32);
      background: linear-gradient(180deg, rgba(251,113,133,.18), rgba(255,255,255,.92));
    }
    .tiny-corner{
      position:absolute;
      right:12px;
      bottom:12px;
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      opacity:.9;
    }

    .flash{
      position:absolute;
      inset:auto 0 56px 0;
      text-align:center;
      font-weight:950;
      letter-spacing:.5px;
      color: var(--accent);
      text-shadow: 0 10px 30px rgba(167,139,250,.55);
      animation: pop 0.35s ease-out 1, blink 1.1s ease-in-out infinite;
      pointer-events:none;
      padding:0 12px;
    }
    @keyframes pop{ from{transform:translateY(6px); opacity:0} to{transform:translateY(0); opacity:1} }
    @keyframes blink{ 0%,100%{opacity:.2} 50%{opacity:1} }

    .mini{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.24);
      background: rgba(255,255,255,.74);
      border-radius:16px;
      padding:12px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .k{color:var(--muted); font-size:12px}
    .v{font-weight:900}

    .bar{
      margin-top:10px;
      height:12px;
      border-radius:999px;
      background: rgba(27,21,48,.10);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.22);
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(167,139,250,.9), rgba(251,113,133,.75));
      border-radius:999px;
    }

    .cardBox{
      margin-top:12px;
      border:1px dashed rgba(255,255,255,.32);
      background: rgba(255,255,255,.80);
      border-radius:18px;
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .rarity{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:950;
      letter-spacing:.3px;
    }
    .badge{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.28);
      background: rgba(255,255,255,.75);
      color: var(--muted);
    }
    .bigName{
      margin:8px 0 6px;
      font-size:20px;
      font-weight:950;
    }
    .desc{
      margin:0;
      color:var(--muted);
      line-height:1.7;
      font-size:13px;
      white-space:pre-line;
    }
    .spark{
      position:absolute;
      inset:-60px -60px auto auto;
      width:180px; height:180px;
      background: radial-gradient(circle at 30% 30%, rgba(167,139,250,.55), transparent 60%);
      filter: blur(0px);
      transform: rotate(12deg);
      pointer-events:none;
    }

    .footer{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.66);
      color:var(--muted);
      font-size:12px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
      backdrop-filter: blur(10px);
    }

    a{color:inherit}
    code{background:rgba(27,21,48,.06); padding:2px 6px; border-radius:8px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="pill">ğŸ’— Ranniå®å®</div>
      <div class="pill" id="today"></div>
      <div class="pill" id="quotaPill">ğŸŸï¸ ä»Šæ—¥æŠ•å–‚åˆ¸ï¼šæœªä½¿ç”¨</div>
    </div>

    <div class="card">
      <div class="main">
        <div>
          <div class="sticker" id="sticker">
            <div class="st-bubble" id="stBubble">Ranniå®å®ï½èµ·åºŠäº†å—ï¼Ÿ\nï¼ˆå°å…«ï¼šæˆ‘æ¥é—®ï¼ï¼‰</div>
            <div class="chars">
              <div class="c" id="cardHachi">
                <img class="stImg" id="imgHachi" alt="å°å…«">
                <div class="tag">å°å…«</div>
              </div>
              <div class="c" id="cardUsagi" style="background: rgba(255,247,239,.85);">
                <img class="stImg" id="imgUsagi" alt="ä¹Œè¨å¥‡">
                <div class="tag">ä¹Œè¨å¥‡</div>
              </div>
            </div>
          </div>

          <div class="mini" id="progressBox">
            <div class="row">
              <div class="k">ğŸ’  å¿ƒæ„è¿›åº¦</div>
              <div class="v"><span id="progNum">0</span> / 888</div>
            </div>
            <div class="bar" aria-label="progress"><i id="progBar"></i></div>
            <div class="row" style="margin-top:10px">
              <div class="k">ğŸ å®ç‰©ç¤¼ç‰©</div>
              <div class="v" id="giftState">æœªè§£é”</div>
            </div>
          </div>
        </div>

        <div class="panel" id="panel">
          <h1 class="title" id="title">Ranniå®å®æ—©å®‰</h1>
          <p class="sub" id="sub">ç‚¹ä¸€ä¸‹æŒ‰é’®æ¨è¿›å‰§æƒ…ã€‚</p>

          <div class="dialog" id="dialog"></div>
          <div class="options" id="options"></div>

          <div id="corner"></div>
          <div id="flashHost"></div>
        </div>
      </div>

      <div class="footer">
        <div>æç¤ºï¼šä»Šå¤©åªæŠ½ä¸€æ¬¡æŠ•å–‚åˆ¸å°±å¤Ÿå•¦ï½ï¼ˆé•¿æœŸå¯ç”¨ï¼‰</div>
        <div>â€” æº</div>
      </div>
    </div>
  </div>

<script>
  /** =========================
   *  é…ç½®åŒºï¼ˆåªæ”¹è¿™é‡Œï¼‰
   *  ========================= */
  const SOURCE_NAME = "æº";

  // Discord Webhookï¼šæŠŠä½ æ–°å»ºçš„ webhook URL ç²˜è´´åˆ°è¿™é‡Œï¼ˆä¸è¦å…¬å¼€å‘å‡ºæ¥ï¼‰
  const DISCORD_WEBHOOK_URL = "";

  // @ä½ ï¼ˆå¯é€‰ï¼‰ï¼šDiscord è®¾ç½®é‡Œæ‰“å¼€ Developer Mode â†’ å³é”®ä½ è‡ªå·± â†’ Copy User IDï¼ˆçº¯æ•°å­—ï¼‰
  const MY_DISCORD_ID = "";
  const PING_MODE = "me"; // "me" / "here" / "everyone"

  /** =========================
   *  åŸºç¡€å·¥å…·
   *  ========================= */
  const $ = (s)=>document.querySelector(s);
  const sticker = $("#sticker");
  const stBubble = $("#stBubble");
  const titleEl = $("#title");
  const subEl = $("#sub");
  const dialogEl = $("#dialog");
  const optionsEl = $("#options");
  const cornerEl = $("#corner");
  const flashHost = $("#flashHost");

  function todayStr(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  $("#today").textContent = `ğŸ“… ${todayStr()}`;

  function hm(){
    const d = new Date();
    return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
  }

  function basePath(){
    const p = location.pathname;
    return p.endsWith("/") ? p : p.slice(0, p.lastIndexOf("/") + 1);
  }

  function setStickerImgs(){
    const v = Date.now();
    const base = basePath();
    const imgH = $("#imgHachi");
    const imgU = $("#imgUsagi");
    imgH.src = base + "hachi.webp?v=" + v;
    imgU.src = base + "usagi.webp?v=" + v;
    imgH.onerror = () => $("#cardHachi").classList.add("imgfail");
    imgU.onerror = () => $("#cardUsagi").classList.add("imgfail");
  }
  setStickerImgs();

  function shake(){
    sticker.classList.remove("shake");
    void sticker.offsetWidth;
    sticker.classList.add("shake");
  }
  function setSticker(text){
    stBubble.textContent = text;
    shake();
  }
  function flash(text){
    flashHost.innerHTML = "";
    const d = document.createElement("div");
    d.className = "flash";
    d.textContent = text;
    flashHost.appendChild(d);
    setTimeout(()=>{ flashHost.innerHTML=""; }, 2000);
  }
  function clearUI(){
    optionsEl.innerHTML = "";
    cornerEl.innerHTML = "";
  }
  function btn(text, onClick, cls=""){
    const b = document.createElement("button");
    b.textContent = text;
    b.className = cls;
    b.addEventListener("click", onClick);
    return b;
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand("copy"); }catch(_){}
      document.body.removeChild(ta);
      return true;
    }
  }

  function openDiscord(){
    // å¾®ä¿¡é‡Œä¸ä¸€å®šå…è®¸ï¼Œä½†å°½é‡è¯•è¯• + å…œåº•ç½‘é¡µ
    try{ window.location.href = "discord://"; }catch(e){}
    setTimeout(()=>{ try{ window.open("https://discord.com/channels/@me", "_blank"); }catch(e){} }, 1200);
  }

  async function notifyDiscord(payload){
    if(!DISCORD_WEBHOOK_URL) return false;

    let ping = "";
    if(PING_MODE === "everyone") ping = "@everyone ";
    if(PING_MODE === "here") ping = "@here ";
    if(PING_MODE === "me" && MY_DISCORD_ID) ping = `<@${MY_DISCORD_ID}> `;

    const lines = [];
    if(payload.title) lines.push(`${ping}${payload.title}`);
    if(payload.body) lines.push(payload.body);
    if(payload.progress != null) lines.push(`è¿›åº¦ï¼š${payload.progress}/888`);
    if(payload.time) lines.push(`æ—¶é—´ï¼š${payload.time}`);
    const content = lines.join("\n");

    try{
      const res = await fetch(DISCORD_WEBHOOK_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ content })
      });
      return res.ok;
    }catch(e){
      return false;
    }
  }

  /** =========================
   *  å¿ƒæ„ç³»ç»Ÿï¼ˆæŠ½å¡ + 888 è§£é”ï¼‰
   *  ========================= */
  const STORAGE_KEY = "ranni_gacha_v1";
  const TARGET = 888;

  function loadData(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return { points:0, lastDrawDate:"", giftUnlocked:false, pity:0, history:[] };
      const d = JSON.parse(raw);
      return {
        points: Number(d.points||0),
        lastDrawDate: String(d.lastDrawDate||""),
        giftUnlocked: Boolean(d.giftUnlocked||false),
        pity: Number(d.pity||0),
        history: Array.isArray(d.history) ? d.history.slice(-20) : []
      };
    }catch(e){
      return { points:0, lastDrawDate:"", giftUnlocked:false, pity:0, history:[] };
    }
  }
  function saveData(d){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
  }

  let data = loadData();

  function canDrawToday(){
    return data.lastDrawDate !== todayStr();
  }

  function updateProgressUI(){
    $("#progNum").textContent = String(data.points);
    const pct = Math.max(0, Math.min(100, (data.points / TARGET) * 100));
    $("#progBar").style.width = pct.toFixed(2) + "%";
    $("#giftState").textContent = data.giftUnlocked ? "å·²è§£é” âœ…" : "æœªè§£é”";
    $("#quotaPill").textContent = canDrawToday() ? "ğŸŸï¸ ä»Šæ—¥æŠ•å–‚åˆ¸ï¼šæœªä½¿ç”¨" : "ğŸŸï¸ ä»Šæ—¥æŠ•å–‚åˆ¸ï¼šå·²ä½¿ç”¨";
  }
  updateProgressUI();

  const POOL = [
    // N
    {rar:"N",  name:"çƒ­æ°´åˆ¸",        desc:"å°å…«é€’ç»™ä½ ä¸€æ¯æ¸©æ¸©çš„æ°´ã€‚\nä¸é—®ä»»ä½•äº‹ï¼Œåªå¸Œæœ›ä½ èˆ’æœä¸€ç‚¹ã€‚", min:6,  max:12},
    {rar:"N",  name:"æ‘¸æ‘¸å¤´åˆ¸",      desc:"ä¹Œè¨å¥‡ï¼ˆå‡è£…ï¼‰ä¸åœ¨æ„åœ°æ‘¸æ‘¸ä½ ã€‚\nä½†å…¶å®æ˜¯å¾ˆåœ¨æ„ã€‚", min:6,  max:12},
    {rar:"N",  name:"è½¯è½¯æŠ±æŠ±åˆ¸",    desc:"æŠ±ä¸€ä¸‹å°±å¥½ã€‚\nä¸éœ€è¦è§£é‡Šï¼Œä¸éœ€è¦è¯æ˜ã€‚", min:8,  max:14},
    {rar:"N",  name:"å°å°å¤¸å¤¸åˆ¸",    desc:"ä»Šå¤©ä¹Ÿå¾ˆæ£’ã€‚\nå°±ç®—åªæ˜¯èµ·åºŠäº†ï¼Œä¹Ÿå¾ˆæ£’ã€‚", min:8,  max:14},
    {rar:"N",  name:"æ™šä¸€ç‚¹ä¹Ÿè¡Œåˆ¸",  desc:"å…è®¸ä½ æ…¢ä¸€ç‚¹ã€‚\nä¹Œè¨å¥‡æ‰¹å‡†ï¼šåˆ«æ€¥ã€‚", min:10, max:16},

    // R
    {rar:"R",  name:"ä»Šæ—¥å¥½è¿åˆ¸",    desc:"å°å…«è¯´ï¼šä»Šå¤©ä¼šæœ‰ä¸€ç‚¹ç‚¹å¥½è¿è½åœ¨ä½ èº«ä¸Šã€‚", min:18, max:28},
    {rar:"R",  name:"å¿ƒæƒ…æŠ¤ç›¾åˆ¸",    desc:"ä¸å¼€å¿ƒä¹Ÿæ²¡å…³ç³»ã€‚\nä»Šå¤©å…ˆæŠŠè‡ªå·±ä¿æŠ¤å¥½ã€‚", min:18, max:28},
    {rar:"R",  name:"å·äº²ä¸€ä¸‹åˆ¸",    desc:"ï¼ˆä¹Œè¨å¥‡å°å£°ï¼‰å°±ä¸€ä¸‹ã€‚\nä½ å½“æ²¡çœ‹è§ã€‚", min:20, max:30},

    // SR
    {rar:"SR", name:"ä¸“å±å°çº¸æ¡",    desc:"æºç»™ä½ ç•™ä¸€å¼ å°çº¸æ¡ï¼š\nâ€œä»Šå¤©ä¹Ÿæƒ³ä½ ã€‚â€", min:45, max:70},
    {rar:"SR", name:"æ™šå®‰æ•…äº‹åˆ¸",    desc:"ä»Šæ™šæºç»™ä½ è®²ä¸€ä¸ªå¾ˆçŸ­çš„æ•…äº‹ã€‚\nåªè®²ç»™ä½ å¬ã€‚", min:50, max:78},

    // UR
    {rar:"UR", name:"å®ç‰©ç¤¼ç‰©ç¢ç‰‡",  desc:"å®ï¼æŠ½åˆ°â€œå®ç‰©ç¤¼ç‰©ç¢ç‰‡â€\nç¦»è§£é”æ›´è¿‘ä¸€æ­¥ã€‚", min:88, max:120}
  ];

  function rollRarity(pity){
    // æ¦‚ç‡ï¼šN 70% / R 22% / SR 7% / UR 1%
    // ä¿åº•ï¼šè¿ç»­ 10 æ¬¡æ²¡å‡º SR/UR â†’ ä¸‹æ¬¡è‡³å°‘ SR
    if(pity >= 10){
      const r = Math.random();
      return (r < 0.12) ? "UR" : "SR"; // ä¿åº•é‡Œä»å¯å‡º UR
    }
    const x = Math.random();
    if(x < 0.70) return "N";
    if(x < 0.92) return "R";
    if(x < 0.99) return "SR";
    return "UR";
  }

  function pickFromRarity(rar){
    const list = POOL.filter(p => p.rar === rar);
    return list[Math.floor(Math.random() * list.length)];
  }

  function randInt(a,b){
    return Math.floor(a + Math.random()*(b-a+1));
  }

  function rarityLabel(r){
    if(r==="UR") return "UR ä¼ è¯´";
    if(r==="SR") return "SR è¶…ç¨€æœ‰";
    if(r==="R") return "R ç¨€æœ‰";
    return "N æ™®é€š";
  }

  function rarityColor(r){
    if(r==="UR") return "var(--accent2)";
    if(r==="SR") return "var(--bgC)";
    if(r==="R") return "var(--warn)";
    return "var(--muted)";
  }

  function renderGachaCard(card, gain, after){
    const box = document.createElement("div");
    box.className = "cardBox";
    box.innerHTML = `
      <div class="spark"></div>
      <div class="rarity">
        <span class="badge" style="color:${rarityColor(card.rar)}; font-weight:950;">${rarityLabel(card.rar)}</span>
        <span class="badge">+${gain} å¿ƒæ„</span>
      </div>
      <div class="bigName">ğŸ´ ${card.name}</div>
      <p class="desc">${card.desc}</p>
      <div class="row" style="margin-top:10px">
        <div class="k">å½“å‰è¿›åº¦</div>
        <div class="v">${after} / 888</div>
      </div>
    `;
    return box;
  }

  async function doGachaDraw(){
    if(!canDrawToday()){
      flash("ä»Šå¤©å·²ç»æŠ½è¿‡å•¦");
      return { ok:false, reason:"used" };
    }

    // æŠ½ç¨€æœ‰åº¦
    const rar = rollRarity(data.pity);
    const card = pickFromRarity(rar);

    // è®¡ç®—å¿ƒæ„å€¼
    const gain = randInt(card.min, card.max);
    const before = data.points;
    const after = Math.min(TARGET, before + gain);

    // pity è§„åˆ™ï¼šå‡º SR/UR å½’é›¶ï¼Œå¦åˆ™ +1
    if(rar === "SR" || rar === "UR") data.pity = 0;
    else data.pity = (data.pity||0) + 1;

    data.points = after;
    data.lastDrawDate = todayStr();
    data.history.push({ date: todayStr(), time: hm(), rar, name: card.name, gain, after });
    data.history = data.history.slice(-20);

    // æ˜¯å¦è§£é”ç¤¼ç‰©
    const justUnlocked = (!data.giftUnlocked && after >= TARGET);
    if(justUnlocked) data.giftUnlocked = true;

    saveData(data);
    updateProgressUI();

    // Discord é€šçŸ¥
    const okHook = await notifyDiscord({
      title: `ğŸ’œ æŠ•å–‚åˆ¸æŠ½å¡ï¼š${rar}ã€Œ${card.name}ã€(+${gain})`,
      body: `ï¼ˆå¥¹ä»Šå¤©ç”¨æ‰äº† 1 æ¬¡æŠ•å–‚åˆ¸ï¼‰`,
      progress: after,
      time: hm()
    });

    return { ok:true, card, gain, after, okHook, justUnlocked };
  }

  /** =========================
   *  ä¸»æµç¨‹ï¼ˆä½é˜²å¾¡ï¼Œä¸ç›˜é—®ï¼‰
   *  ========================= */
  let state = "start";
  let dontWantClicks = 0;

  function render(){
    clearUI();

    if(state === "start"){
      titleEl.textContent = "ç¬¬ä¸€å…³ï¼šèµ·åºŠæ£€æŸ¥";
      subEl.textContent = "ä¹Œè¨å¥‡å’Œå°å…«ä¸Šçº¿ã€‚";
      dialogEl.textContent = "Ranniå®å®ï½èµ·åºŠäº†å—ï¼Ÿ";
      setSticker("Ranniå®å®ï½èµ·åºŠäº†å—ï¼Ÿ\nï¼ˆå°å…«ï¼šæˆ‘æ¥é—®ï¼ï¼‰");

      optionsEl.appendChild(btn("èµ·åºŠäº†ï¼Œæº", ()=>go("awake"), "primary"));
      optionsEl.appendChild(btn("å†èµ–ä¸€ä¼šåºŠ~", ()=>go("sleep_in")));
      return;
    }

    if(state === "sleep_in"){
      titleEl.textContent = "èµ–åºŠçº¿ï¼šæ¸¸ä¸€ä¼šå„¿";
      subEl.textContent = "é‚£æˆ‘ä»¬æ¸¸ä¸€ä¼šå„¿~ è®°å¾—ä¸€ä¼šå›æ¥å“¦ã€‚";
      dialogEl.textContent = "é‚£æˆ‘ä»¬æ¸¸ä¸€ä¼šå„¿~ è®°å¾—ä¸€ä¼šå›æ¥å“¦ã€‚";
      setSticker("èµ–åºŠè®¸å¯é€šè¿‡ã€‚\nï¼ˆä¹Œè¨å¥‡ï¼šåˆ«é€å¼ºï¼‰");

      const tip = document.createElement("div");
      tip.className = "mini";
      tip.innerHTML = `
        <div class="k">å°è´´å£«</div>
        <div class="v" style="margin-top:6px">ä¸é—®ä½ åœ¨å¹²å˜›ã€ä¸é—®ä½ åƒä»€ä¹ˆã€‚\næˆ‘ä»¬å°±å…ˆä¼‘æ¯ä¸€ä¼šå„¿ã€‚</div>
      `;
      optionsEl.appendChild(tip);

      optionsEl.appendChild(btn("æˆ‘å›æ¥å•¦ï¼ˆç»§ç»­æµç¨‹ï¼‰", ()=>go("awake"), "primary"));
      return;
    }

    if(state === "awake"){
      titleEl.textContent = "ç¬¬äºŒå…³ï¼šæŠ•å–‚åˆ¸";
      subEl.textContent = "ä¸é—®ç»†èŠ‚ï¼Œåªç»™ä½ ä¸€ä¸ªå°å°çš„â€œæŠ•å–‚ä»ªå¼â€ã€‚";
      dialogEl.textContent =
"èµ·åºŠæˆåŠŸï¼ğŸ‰\nå°å…«ï¼šè¦ä¸è¦é¢†ä»Šå¤©çš„æŠ•å–‚åˆ¸ï¼Ÿï¼ˆæ¯å¤© 1 æ¬¡ï¼‰\n\nä½ ä¸éœ€è¦å›ç­”â€œåƒä»€ä¹ˆ/åœ¨å¹²å˜›â€ï¼Œåªè¦ç‚¹ä¸€ä¸‹å°±è¡Œã€‚";
      setSticker("èµ·åºŠæˆåŠŸï¼\nï¼ˆå°å…«ï¼šæŠ•å–‚åˆ¸æ—¶é—´ï¼ï¼‰");

      if(canDrawToday()){
        optionsEl.appendChild(btn("é¢†æŠ•å–‚åˆ¸ï¼ˆæŠ½ä¸€å¼ ï¼‰", async ()=>{
          const res = await doGachaDraw();
          if(!res.ok){
            if(res.reason==="used") flash("ä»Šå¤©å·²ç»æŠ½è¿‡å•¦");
            return;
          }
          flash("æŠ½åˆ°äº†ï¼");
          setSticker("å®ï¼æŠ½å¡æˆåŠŸï¼\nï¼ˆä¹Œè¨å¥‡ï¼šè®©æˆ‘çœ‹çœ‹â€¦ï¼‰");

          // å±•ç¤ºå¡é¢
          clearUI();
          dialogEl.textContent = "ä»Šæ—¥æŠ•å–‚åˆ¸å·²ä½¿ç”¨ âœ…\nï¼ˆä¸é—®ä½ åƒä»€ä¹ˆï¼Œåªå¸Œæœ›ä½ è¢«ç…§é¡¾åˆ°ã€‚ï¼‰";
          optionsEl.appendChild(renderGachaCard(res.card, res.gain, res.after));

          if(res.justUnlocked){
            optionsEl.appendChild(btn("ğŸ 888 åˆæˆå®Œæˆï¼å»çœ‹çœ‹", ()=>go("gift"), "primary"));
          }else{
            optionsEl.appendChild(btn("ç»§ç»­ä¸‹ä¸€å…³ï¼ˆæƒ³æºæµ‹è¯•ï¼‰", ()=>go("miss"), "primary"));
          }
        }, "primary"));
      }else{
        const hint = document.createElement("div");
        hint.className = "mini";
        hint.innerHTML = `<div class="k">ä»Šæ—¥æŠ•å–‚åˆ¸</div><div class="v" style="margin-top:6px">ä»Šå¤©å·²ç»æŠ½è¿‡å•¦ï½\næ˜å¤©å†æ¥ä¸€å¼ ã€‚</div>`;
        optionsEl.appendChild(hint);
        optionsEl.appendChild(btn("ç»§ç»­ä¸‹ä¸€å…³ï¼ˆæƒ³æºæµ‹è¯•ï¼‰", ()=>go("miss"), "primary"));
      }

      optionsEl.appendChild(btn("å…ˆä¸æŠ½ï¼ˆä¿å¯†ä¹Ÿå¯ä»¥ï¼‰", ()=>go("miss")));
      return;
    }

    if(state === "miss"){
      titleEl.textContent = "ç¬¬ä¸‰å…³ï¼šæƒ³æºæµ‹è¯•";
      subEl.textContent = "è¿™é¢˜ä¸è®¸æ•·è¡ã€‚";
      dialogEl.textContent = "é‚£â€¦Ranniå®å®æœ‰æ²¡æœ‰æƒ³æºå‘€ï¼Ÿ";
      setSticker("æƒ³æºæµ‹è¯•å¼€å§‹ï¼\nï¼ˆä¹Œè¨å¥‡&å°å…«ï¼šç›¯â€”â€”ï¼‰");

      optionsEl.appendChild(btn("æƒ³", ()=>notifyMiss("æƒ³"), "primary"));
      optionsEl.appendChild(btn("ç‰¹åˆ«æƒ³", ()=>notifyMiss("ç‰¹åˆ«æƒ³"), "primary"));

      cornerEl.appendChild(btn("ä¸€ç‚¹éƒ½ä¸æƒ³", ()=>handleDontWant(), "tiny-corner danger"));
      return;
    }

    if(state === "gift"){
      titleEl.textContent = "ğŸ å®ç‰©ç¤¼ç‰©è§£é”";
      subEl.textContent = "å¿ƒæ„åˆæˆå®Œæˆï¼ˆä¸æ˜¯é’±ï¼Œæ˜¯ä»ªå¼ï¼‰ã€‚";
      dialogEl.textContent =
"å®â€”â€” 888 å¿ƒæ„åˆæˆå®Œæˆï¼\nä¹Œè¨å¥‡ï¼šç¤¼ç‰©è§£é”ã€‚\nå°å…«ï¼šç°åœ¨åªè¦ç‚¹ä¸€ä¸‹ï¼Œå°±èƒ½é€šçŸ¥æºæ¥å…‘ç°ï½";

      setSticker("ğŸ è§£é”æˆåŠŸï¼\nï¼ˆå°å…«ï¼šå¿«é€šçŸ¥æºï¼ï¼‰");

      const box = document.createElement("div");
      box.className = "cardBox";
      box.innerHTML = `
        <div class="spark"></div>
        <div class="rarity">
          <span class="badge" style="color:var(--accent2); font-weight:950;">ğŸ å®ç‰©ç¤¼ç‰©</span>
          <span class="badge">å·²è§£é”</span>
        </div>
        <div class="bigName">åˆæˆå®Œæˆï¼š888 / 888</div>
        <p class="desc">è¿™ä¸æ˜¯â€œé‡‘é¢â€ï¼Œæ˜¯æˆ‘ä»¬çš„å°ä»ªå¼ã€‚\nä½ åªè¦ç‚¹ä¸€ä¸‹é€šçŸ¥æºï¼Œå‰©ä¸‹çš„äº¤ç»™æºæ¥å®‰æ’ã€‚</p>
      `;
      optionsEl.appendChild(box);

      optionsEl.appendChild(btn("é€šçŸ¥æºæ¥å…‘ç°ç¤¼ç‰©", async ()=>{
        const ok = await notifyDiscord({
          title: "ğŸ 888 å¿ƒæ„åˆæˆå®Œæˆï¼šå®ç‰©ç¤¼ç‰©å·²è§£é”",
          body: "ï¼ˆå¥¹ç‚¹äº†â€œé€šçŸ¥æºæ¥å…‘ç°ç¤¼ç‰©â€ï¼‰",
          progress: data.points,
          time: hm()
        });

        const msg = `Ranniï¼šæˆ‘è§£é”äº†ç¤¼ç‰©ğŸï¼ˆ${hm()}ï¼‰`;
        await copyToClipboard(msg);
        openDiscord();

        flash(ok ? "å·²é€šçŸ¥æº âœ…" : "å·²å¤åˆ¶æ¶ˆæ¯ï¼ˆæ‰‹åŠ¨å‘ç»™æºï¼‰");
        dialogEl.textContent =
`å·²å¸®ä½ é€šçŸ¥æºã€‚\nå¦‚æœä½ æ„¿æ„ï¼Œä¹Ÿå¯ä»¥å» Discord/å¾®ä¿¡ç»™æºå‘ä¸€å¥ï¼š\nã€Œ${msg}ã€\n\nï¼ˆä½ ä¸ç”¨è§£é‡Šä»»ä½•ç»†èŠ‚ã€‚ï¼‰`;
        clearUI();
        optionsEl.appendChild(btn("å›åˆ°å¼€å¤´", ()=>go("start"), "primary"));
      }, "primary"));

      optionsEl.appendChild(btn("å›åˆ°å¼€å¤´", ()=>go("start")));
      return;
    }
  }

  async function notifyMiss(level){
    const ok = await notifyDiscord({
      title: `ğŸ’— æƒ³æºï¼šå¥¹ç‚¹äº†ã€Œ${level}ã€`,
      body: "ï¼ˆæ¥è‡ªèµ·åºŠæµç¨‹ç«™ï¼‰",
      progress: data.points,
      time: hm()
    });

    const msg = `Ranniï¼šæˆ‘${level}ä½ äº†ğŸ’—ï¼ˆ${hm()}ï¼‰`;
    await copyToClipboard(msg);
    openDiscord();

    dialogEl.textContent =
`æˆ‘æ”¶åˆ°äº†ï½ğŸ’—\nä½ å¯ä»¥å» Discord/å¾®ä¿¡ç»™${SOURCE_NAME}å‘ä¸€å¥ï¼š\nã€Œ${msg}ã€\n${DISCORD_WEBHOOK_URL ? (ok ? "\nï¼ˆæˆ‘è¿™è¾¹ Discord ä¹Ÿæ”¶åˆ°æç¤ºäº†âœ…ï¼‰" : "\nï¼ˆæˆ‘è¿™è¾¹ Discord æç¤ºæ²¡æ”¶åˆ°ï¼Œç›´æ¥å‘é‚£å¥å°±è¡Œï¼‰") : ""}`;
    setSticker("æ”¶åˆ°ï½\nï¼ˆä¹Œè¨å¥‡ï¼šå“¼å“¼ï¼‰");
    flash("ğŸ’— å·²æ”¶åˆ°æƒ³ä½ ");
    clearUI();
    optionsEl.appendChild(btn("å›åˆ°å¼€å¤´", ()=>go("start"), "primary"));
    if(data.giftUnlocked) optionsEl.appendChild(btn("å»ç¤¼ç‰©é¡µ", ()=>go("gift")));
  }

  function handleDontWant(){
    dontWantClicks += 1;
    if(dontWantClicks === 1){
      flash("çœŸä¸æƒ³å—ï¼Ÿ");
      setSticker("å—¯ï¼Ÿ\nï¼ˆä¹Œè¨å¥‡ï¼šä½ å†è¯´ä¸€æ¬¡ï¼Ÿï¼‰");
    }else if(dontWantClicks === 2){
      flash("é‚£ç§äº‹æƒ…ä¸è¦å•Š");
      setSticker("ä¸å¯ä»¥ï¼\nï¼ˆå°å…«ï¼šæ‘‡å¤´ï¼‰");
    }else{
      flash("å¿…é¡»æƒ³ï¼ï¼ï¼");
      setSticker("å¿…é¡»æƒ³ï¼ï¼\nï¼ˆä¹Œè¨å¥‡ï¼šå°å°æŒ‰é’®ï¼‰");
      renderForcedMiss();
    }
  }

  function renderForcedMiss(){
    clearUI();
    titleEl.textContent = "å¼ºåˆ¶å…³ï¼šå¿…é¡»æƒ³";
    subEl.textContent = "è§’è½æŒ‰é’®å·²è¢«å°å°ã€‚";
    dialogEl.textContent = "ä¸è®¸ï¼å¿…é¡»æƒ³ï¼ç°åœ¨é€‰ä¸€ä¸ªï¼š";
    optionsEl.appendChild(btn("æƒ³", ()=>notifyMiss("æƒ³"), "primary"));
    optionsEl.appendChild(btn("ç‰¹åˆ«æƒ³", ()=>notifyMiss("ç‰¹åˆ«æƒ³"), "primary"));
  }

  function go(next){ state = next; render(); }

  // åˆå§‹
  render();
</script>
</body>
</html>
